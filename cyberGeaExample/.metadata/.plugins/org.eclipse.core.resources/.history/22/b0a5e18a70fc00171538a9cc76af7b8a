package org.cyberGea.eventGenerators;
import org.eclipse.paho.client.mqttv3.IMqttDeliveryToken;
import org.eclipse.paho.client.mqttv3.MqttCallback;
import org.eclipse.paho.client.mqttv3.MqttClient;
import org.eclipse.paho.client.mqttv3.MqttConnectOptions;
import org.eclipse.paho.client.mqttv3.MqttException;
import org.eclipse.paho.client.mqttv3.MqttMessage;
import org.osgi.framework.BundleActivator;
import org.osgi.framework.BundleContext;

public class Activator implements BundleActivator, MqttCallback
{
	DataPublisher publisher;
	MqttClient sub;
	TemperatureSensor first;
	PressureSensor soilChecker;	
	HumiditySensor humidSensor;
	LightSensor lightChecker;
	AirSensor airChecker;
	Sensor camera;
	String[] product;
	boolean startCamera = false;
	/*
	 * (non-Javadoc)
	 * @see org.osgi.framework.BundleActivator#start(org.osgi.framework.BundleContext)
	 */
	
	public void start(BundleContext context) throws Exception
	{
		publisher = new DataPublisher();
		System.out.println("Starting Sensors...");
		setSub();
		first = new TemperatureSensor(publisher, 10, 60, "tempS1");
		soilChecker=new PressureSensor(publisher,20,30,"soilS1");
		humidSensor=new HumiditySensor(publisher, 30, 40, "humidS1");
		lightChecker=new LightSensor(publisher, 20, 50, "lightS1");
		airChecker= new AirSensor(publisher, 3, 5, "airS1");
		
		
		
	}
	/*
	 * (non-Javadoc)
	 * @see org.osgi.framework.BundleActivator#stop(org.osgi.framework.BundleContext)
	 */
	
	public void stop(BundleContext context) throws Exception 
	{
		first.stopSensing();
		publisher.publisherDisconnection();
		soilChecker.stopMeasure();
		//humidSensor.stopHumiditySensor();
		System.out.println("Sensors have been stopped");
	}
	
	
	public void setSub() throws MqttException
	{
		sub = new MqttClient("tcp://localhost:1883","cameraSub");
		MqttConnectOptions opts = new MqttConnectOptions();	
		sub.setCallback(this);
		sub.connect(opts);		
		sub.subscribe("startcamera");
	}
	
	@Override
	public void connectionLost(Throwable arg0) {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void deliveryComplete(IMqttDeliveryToken arg0) {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void messageArrived(String arg0, MqttMessage arg1) throws Exception {
		System.out.println("Arrived fff" + arg1.toString());
		//this.product=arg1.toString().split(",");
		System.out.println("primo"+product[0]);
		
		
		this.camera=new Sensor(new DataPublisher(),"rawData/camera",0,100,product);
		
		if(this.startCamera==false)
		{
			System.out.println("if enter");
			
			System.out.println("ciao");
			this.startCamera = true;
			System.out.println(startCamera);
			
			
		}else
		{
			
			this.camera.runGrowth(product);
			
		}

	}

}
